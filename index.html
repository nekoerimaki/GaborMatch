<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガボールマッチ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1a202c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            margin: 2rem;
            text-align: center;
        }
        /* 縦幅が狭い画面用のスタイル */
        .container.compact-y {
            padding-top: 1rem;
            padding-bottom: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .container.compact-y .grid {
            gap: 0.25rem; /* 8px -> 4px */
            padding: 0.25rem; /* 8px -> 4px */
        }
        .container.compact-y #game-controls-container {
            margin-top: 1rem; /* mt-4 */
        }
        .grid {
            display: grid;
            gap: 1rem;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 1rem;
        }
        .card {
            background-color: #4a5568;
            border-radius: 0.5rem;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card.matched {
            pointer-events: none;
            cursor: default;
        }
        .card-inner {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border-radius: inherit;
        }
        .card-front {
            background-color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            transform: rotateY(180deg);
        }
        .card-back {
            background-color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotateY(0deg);
        }
        .gabor-patch {
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #3182ce;
            color: white;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #2b6cb0;
            transform: translateY(-2px);
        }
        .info {
            margin-top: 1rem;
            text-align: center;
        }
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            justify-content: center;
        }
        .reaction-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 3rem;
            font-weight: bold;
            color: #ef4444; /* red-500 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            animation: pop-up 0.5s forwards;
            pointer-events: none;
        }
        @keyframes pop-up {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
        }
        .give-up-btn {
            background-color: #e53e3e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }
        .give-up-btn:hover {
            background-color: #c53030;
            transform: translateY(-2px);
        }
        .win-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem;
            font-weight: bold;
            color: #38a169; /* green-500 */
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3);
            animation: fly-in-out 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            z-index: 1000;
            pointer-events: none;
        }
        @keyframes fly-in-out {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(360deg); opacity: 1; }
            100% { transform: scale(0) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="lang-switcher" class="absolute top-4 right-8 z-50">
        <button id="lang-ja" class="btn mr-2">日本語</button>
        <button id="lang-en" class="btn">English</button>
    </div>

<div class="container flex flex-col items-center">
    <h1 id="main-title" class="text-3xl font-bold mb-4">ガボールマッチ</h1>
    <div class="info mb-1">
        <div id="message-area" class="text-gray-700">
            <p id="message-desc" class="text-sm mb-2"></p>
            <p id="message-select" class="text-lg">ゲームモードを選択してください。</p>
        </div>
        <p id="timer" class="timer-display hidden">タイム: 0分0秒</p>
    </div>
    <div id="mode-selection" class="mode-buttons mt-6">
        <!-- ボタンテキストはJSで設定 -->
        <button id="easy-btn" class="btn"></button>
        <button id="hard-btn" class="btn"></button>
    </div>
    
    <div class="grid" id="card-grid"></div>

    <div class="flex-grow mt-4" id="game-controls-container">
        <button id="main-action-btn" class="give-up-btn hidden">ギブアップ</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('card-grid');
        const container = document.querySelector('.container');
        const modeSelection = document.getElementById('mode-selection');
        const easyBtn = document.getElementById('easy-btn');
        const hardBtn = document.getElementById('hard-btn');
        const messageDesc = document.getElementById('message-desc');
        const messageSelect = document.getElementById('message-select');
        const timerDisplay = document.getElementById('timer');
        const gameControlsContainer = document.getElementById('game-controls-container');
        const mainTitle = document.getElementById('main-title');
        const langSwitcher = document.getElementById('lang-switcher');
        const mainActionBtn = document.getElementById('main-action-btn');

        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let isProcessing = false;
        let numCards = 0;
        let gridCols = '';
        let timerInterval;
        let startTime;
        let timerStarted = false;

        // ガボールパッチを生成する関数
        function createGaborPatch(frequency, orientation, phase, size) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const halfSize = size / 2;
            canvas.width = size;
            canvas.height = size;

            for (let x = 0; x < size; x++) {
                for (let y = 0; y < size; y++) {
                    const xPrime = (x - halfSize) * Math.cos(orientation) + (y - halfSize) * Math.sin(orientation);
                    const yPrime = -(x - halfSize) * Math.sin(orientation) + (y - halfSize) * Math.cos(orientation);
                    const exponent = -((xPrime * xPrime) + (yPrime * yPrime)) / (2 * (size / 6) ** 2);
                    const sinusoidal = Math.cos(2 * Math.PI * frequency * xPrime + phase);
                    const intensity = 0.5 + 0.5 * Math.exp(exponent) * sinusoidal;
                    const gray = Math.floor(intensity * 255);
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(x, y, 1, 1);
                }
            }
            return canvas.toDataURL();
        }

        // ゲームを初期化する
        function initializeGame(mode) {
            grid.innerHTML = '';
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            isProcessing = false;
            
            clearInterval(timerInterval);
            timerStarted = false;
            timerDisplay.textContent = texts[lang].time(0, 0); // ←ここを修正
            timerDisplay.classList.remove('hidden');
            mainActionBtn.classList.remove('hidden');
            mainActionBtn.textContent = texts[lang].giveup;    // ←ここを修正
            mainActionBtn.classList.remove('btn');
            mainActionBtn.classList.add('give-up-btn');
            mainActionBtn.onclick = () => resetGame();

            mainTitle.classList.add('hidden');
            langSwitcher.classList.add('hidden');
            document.getElementById('message-area').classList.add('hidden');

            // 画面の高さに応じて余白を調整
            if (window.innerHeight < 1000) {
                container.classList.add('compact-y');
            }

            const isPortrait = window.innerHeight > window.innerWidth;

            modeSelection.innerHTML = '';

            if (mode === 'easy') {
                numCards = 16;
                gridCols = 'repeat(4, 1fr)';
                const cardSize = isPortrait ? 60 : 80;
                
                const patchData = [
                    { freq: 0.1, ori: 0 }, { freq: 0.1, ori: Math.PI / 4 },
                    { freq: 0.1, ori: Math.PI / 2 }, { freq: 0.1, ori: 3 * Math.PI / 4 },
                    { freq: 0.05, ori: 0 }, { freq: 0.05, ori: Math.PI / 4 },
                    { freq: 0.05, ori: Math.PI / 2 }, { freq: 0.05, ori: 3 * Math.PI / 4 },
                ].flatMap((p, index) => {
                    const imageUrl = createGaborPatch(p.freq, p.ori, 0, cardSize);
                    return [{ id: index, src: imageUrl }, { id: index, src: imageUrl }];
                });
                renderCards(patchData, cardSize);

            } else { // hard mode
                numCards = 36;
                gridCols = isPortrait ? 'repeat(4, 1fr)' : 'repeat(6, 1fr)';

                const patchData = [];
                const frequencies = [0.05, 0.06, 0.08, 0.1, 0.12];
                const orientations = [0, Math.PI / 4, Math.PI / 2, 3 * Math.PI / 4];
                let idCounter = 0;
                for (let f of frequencies) {
                    for (let o of orientations) {
                        if (idCounter >= numCards / 2) break;
                        const cardSize = isPortrait ? 60 : 80;
                        const imageUrl = createGaborPatch(f, o, 0, cardSize);
                        patchData.push({ id: idCounter, src: imageUrl }, { id: idCounter, src: imageUrl });
                        idCounter++;
                    }
                    if (idCounter >= numCards / 2) break;
                }
                renderCards(patchData, isPortrait ? 60 : 80);
            }

            grid.style.gridTemplateColumns = gridCols;
        }

        function renderCards(patchData, cardSize) {
            patchData.sort(() => 0.5 - Math.random());
            patchData.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.style.width = `${cardSize}px`;
                card.style.height = `${cardSize}px`;
                card.dataset.id = item.id;
                
                const cardFront = document.createElement('div');
                cardFront.classList.add('card-inner', 'card-front');
                const img = document.createElement('img');
                img.src = item.src;
                img.classList.add('gabor-patch');
                cardFront.appendChild(img);
                
                const cardBack = document.createElement('div');
                cardBack.classList.add('card-inner', 'card-back');

                card.appendChild(cardFront);
                card.appendChild(cardBack);

                card.addEventListener('click', () => handleCardClick(card));
                grid.appendChild(card);
                cards.push(card);
            });
        }

        // カードクリック時の処理
        function handleCardClick(card) {
            if (isProcessing || card.classList.contains('matched') || flippedCards.length >= 2) {
                return;
            }

            if (!timerStarted) {
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000); // 1秒ごとに更新
                timerStarted = true;
            }

            if (flippedCards.length === 1 && flippedCards[0] === card) {
                card.classList.remove('flipped');
                flippedCards = [];
                return;
            }

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                isProcessing = true;
                const [card1, card2] = flippedCards;
                if (card1.dataset.id === card2.dataset.id) {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    showReactionMessage('ビンゴ！');
                    flippedCards = [];
                    isProcessing = false;
                    checkGameOver();
                } else {
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                        isProcessing = false;
                    }, 1000);
                }
            }
        }

        // 言語辞書
        const texts = {
            ja: {
                title: "ガボールマッチ",
                description: "カードをめくってペアを見つけてください。",
                selectMode: "ゲームモードを選択してください。",
                easy: (n) => `初級モード (${n}枚)`,
                hard: (n) => `上級モード (${n}枚)`,
                time: (m, s) => `タイム: ${m}分${s}秒`,
                giveup: "ギブアップ",
                bingo: "ビンゴ！",
                clear: "クリア！",
                clearMsg: (m, s) => `ゲームクリア！クリアタイム: ${m}分${s}秒 🎉`,
                replay: "もう一度プレイ"
            },
            en: {
                title: "Gabor Match",
                selectMode: "Please select a game mode.",
                description: "Flip cards and find the matching pairs.",
                time: (m, s) => `Time: ${m}m ${s}s`,
                easy: (n) => `Easy (${n} cards)`,
                hard: (n) => `Hard (${n} cards)`,
                giveup: "Give Up",
                bingo: "Bingo!",
                clear: "Clear!",
                clearMsg: (m, s) => `Game Clear! Time: ${m}m ${s}s 🎉`,
                replay: "Play Again"
            }
        };
        let lang = 'ja';

        // UI更新関数
        function updateUIText() {
            document.querySelector('h1').textContent = texts[lang].title;
            messageDesc.textContent = texts[lang].description;
            messageSelect.textContent = texts[lang].selectMode;
            easyBtn.textContent = texts[lang].easy(16);
            hardBtn.textContent = texts[lang].hard(36);
        }

        // カードクリック時の処理
        function handleCardClick(card) {
            if (isProcessing || card.classList.contains('matched') || flippedCards.length >= 2) {
                return;
            }

            if (!timerStarted) {
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000); // 1秒ごとに更新
                timerStarted = true;
            }

            if (flippedCards.length === 1 && flippedCards[0] === card) {
                card.classList.remove('flipped');
                flippedCards = [];
                return;
            }

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                isProcessing = true;
                const [card1, card2] = flippedCards;
                if (card1.dataset.id === card2.dataset.id) {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    showReactionMessage(texts[lang].bingo);
                    flippedCards = [];
                    isProcessing = false;
                    checkGameOver();
                } else {
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                        isProcessing = false;
                    }, 1000);
                }
            }
        }

        // showReactionMessage内
        function showReactionMessage(msg) {
            const reactionMsg = document.createElement('div');
            reactionMsg.textContent = msg;
            reactionMsg.classList.add('reaction-message');
            document.body.appendChild(reactionMsg);
            setTimeout(() => {
                reactionMsg.remove();
            }, 1000);
        }

        // showWinMessage内
        function showWinMessage() {
            const winMsg = document.createElement('div');
            winMsg.textContent = texts[lang].clear;
            winMsg.classList.add('win-message');
            document.body.appendChild(winMsg);
            setTimeout(() => {
                winMsg.remove();
            }, 2000);
        }

        // updateTimer内
        function updateTimer() {
            const elapsedTimeInSeconds = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedTimeInSeconds / 60);
            const seconds = elapsedTimeInSeconds % 60;
            timerDisplay.textContent = texts[lang].time(minutes, seconds);
        }

        // resetGame内
        function resetGame() {
            clearInterval(timerInterval);
            grid.innerHTML = '';
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            isProcessing = false;
            timerStarted = false;
            timerDisplay.classList.add('hidden');
            mainActionBtn.classList.add('hidden');
            modeSelection.innerHTML = '';
            modeSelection.appendChild(easyBtn);
            modeSelection.appendChild(hardBtn);
            document.getElementById('message-area').classList.remove('hidden');
            updateUIText();
            mainTitle.classList.remove('hidden');
            langSwitcher.classList.remove('hidden');
            container.classList.remove('compact-y');
        }

        // checkGameOver内
        function checkGameOver() {
            if (matchedPairs === numCards / 2) {
                clearInterval(timerInterval);
                const finalTimeInSeconds = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(finalTimeInSeconds / 60);
                const seconds = finalTimeInSeconds % 60;
                // message.textContent = texts[lang].clearMsg(minutes, seconds);

                showWinMessage();

                mainActionBtn.textContent = texts[lang].replay;
                mainActionBtn.classList.remove('give-up-btn');
                mainActionBtn.classList.add('btn');
                
                mainActionBtn.onclick = () => {
                    modeSelection.innerHTML = '';
                    modeSelection.appendChild(easyBtn);
                    modeSelection.appendChild(hardBtn);
                    document.getElementById('message-area').classList.remove('hidden');
                    updateUIText();
                    timerDisplay.classList.add('hidden');
                    mainActionBtn.classList.add('hidden');
                    grid.innerHTML = '';
                    container.classList.remove('compact-y');
                };
            }
        }

        // 言語切り替えイベント
        document.getElementById('lang-ja').onclick = () => {
            lang = 'ja';
            updateUIText();
        };
        document.getElementById('lang-en').onclick = () => {
            lang = 'en';
            updateUIText();
        };

        // 初期UI反映
        updateUIText();
        
        easyBtn.addEventListener('click', () => initializeGame('easy'));
        hardBtn.addEventListener('click', () => initializeGame('hard'));
        
    });
</script>

</body>
</html>
